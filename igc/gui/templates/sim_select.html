{% extends "base.html" %}
{% block title %}Select · Simulation{% endblock %}
{% block content %}
<section class="igc-page">
  <!-- 1) HEADER (one column) -->
  <header class="igc-header">
    <h1 class="igc-title">Select Simulation</h1>
    <p class="igc-subtitle">
      Mode: <strong>{{ mode|default('run') }}</strong> · Choose a simulation, then press Next.
    </p>
  </header>

  <!-- 2) MAIN: left = list (50% width button behavior), right = description/help -->
  <main class="igc-main two-col">
    <div class="igc-col">
      <!-- List of sims (robust to empty) -->
      {% set items = sims|default([]) %}
      {% if items|length == 0 %}
        <div class="igc-empty igc-card">
          <p>No simulations found.</p>
          <p>You can go Back and choose <em>New Simulation</em>, or keep this page and refresh once you’ve created one.</p>
        </div>
      {% else %}
        <ul class="igc-listbox" role="listbox" aria-label="Simulations">
          {% for s in items %}
            {# accept either dicts or objects with .id/.name #}
            {% set sid = (s.id if s is defined and s.id is defined else s.get('id')) %}
            {% set label = (s.name if s is defined and s.name is defined else s.get('name', 'Unnamed')) %}
            <li class="igc-option" role="option" data-sid="{{ sid|e }}">
              <button type="button" class="btn btn-choice btn-lg igc-btn-100" data-sid="{{ sid|e }}">{{ label|e }}</button>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="igc-col">
      <div class="igc-desc igc-card">
        <h2>What happens next</h2>
        <dl class="igc-list">
          <dt>Run</dt>
          <dd>Launches the selected simulation with its saved parameters.</dd>
          <dt>Edit</dt>
          <dd>Opens the selected simulation for editing.</dd>
          <dt>Sweep</dt>
          <dd>Uses the selected simulation as a base for a parameter sweep.</dd>
        </dl>
        <p class="hint">Tip: You can sort/filter here later; this is a minimal working page.</p>
      </div>
    </div>
  </main>

  <!-- 3) FOOTER: Back / Next; Next disabled until a sim is chosen -->
  <footer class="igc-footer two-col">
    <div class="igc-col igc-col--left">
      <a class="btn btn-outline btn-lg" href="{{ request.url_for('sim_start') }}">Back</a>
    </div>
    <div class="igc-col igc-col--right igc-align-end">
      <a id="nextBtn" class="btn btn-primary btn-lg is-disabled" aria-disabled="true">Next</a>
    </div>
  </footer>
</section>

<style>
  :root{
    --ink:#0f172a; --ink-2:#334155; --bg:#ffffff; --line:#e2e8f0;
    --btn:#0f172a; --btn-ink:#ffffff; --radius:12px;
  }
  .igc-page{display:flex;flex-direction:column;gap:16px;padding:20px;background:var(--bg);color:var(--ink);}
  .igc-header{border:1px solid var(--line);border-radius:var(--radius);padding:16px;background:#fff}
  .igc-title{margin:0;font-size:1.375rem;line-height:1.2}
  .igc-subtitle{margin:.25rem 0 0;color:var(--ink-2)}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .igc-footer{align-items:center}
  .igc-align-end{display:flex;justify-content:flex-end}
  .igc-card{border:1px solid var(--line);border-radius:var(--radius);padding:16px;background:#fff}
  .igc-listbox{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
  .igc-option .btn{width:100%}
  .btn{display:inline-flex;align-items:center;justify-content:center;
       padding:12px 16px;border-radius:10px;border:1px solid var(--ink);
       font-weight:600;text-decoration:none;cursor:pointer;user-select:none}
  .btn-lg{font-size:1rem;line-height:1;min-height:44px;min-width:120px}
  .btn-primary{background:var(--btn);color:var(--btn-ink);border-color:var(--btn)}
  .btn-outline{background:#fff;color:var(--ink)}
  .btn-choice{background:#fff;color:var(--ink)}
  .btn-choice.selected{background:var(--btn);color:var(--btn-ink);border-color:var(--btn)}
  .is-disabled{opacity:.5;cursor:not-allowed;pointer-events:none}
  @media (max-width: 900px){ .two-col{grid-template-columns:1fr} }
</style>

<script>
  // Determine where "Next" should go, based on mode and selected sim id.
  // Adjust route names if yours differ (these are from your sim_flow).
  const mode = "{{ mode|default('run') }}";
  const routes = {
    run:   (sid) => "{{ request.url_for('sim_confirm_get') }}" + "?mode=run&id=" + encodeURIComponent(sid),
    edit:  (sid) => "{{ request.url_for('sim_edit_get') }}"    + "?mode=edit&id=" + encodeURIComponent(sid),
    sweep: (sid) => "{{ request.url_for('sim_confirm_get') }}" + "?mode=sweep&id=" + encodeURIComponent(sid),
    // fallback for unknown mode
    "":    (sid) => "{{ request.url_for('sim_confirm_get') }}" + "?id=" + encodeURIComponent(sid),
  };

  const nextBtn = document.getElementById('nextBtn');
  const options = Array.from(document.querySelectorAll('.btn-choice'));
  let selected = null;

  function setSelected(btn) {
    options.forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selected = btn.getAttribute('data-sid');
    if (selected) {
      const build = routes[mode] || routes[""];
      nextBtn.setAttribute('href', build(selected));
      nextBtn.classList.remove('is-disabled');
      nextBtn.setAttribute('aria-disabled', 'false');
    }
  }

  options.forEach(btn => {
    btn.addEventListener('click', () => setSelected(btn));
  });
</script>
{% endblock %}
