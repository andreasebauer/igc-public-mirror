#!/usr/bin/env bash
set -Eeuo pipefail

usage(){ echo "Usage: $0 --file PATH --cmd 'ED_CMD' [--cmd 'ED_CMD']... [--verify-absent REGEX]... [--verify-present REGEX]... [--keep-bak]"; exit 2; }

F=""; KEEP_BAK=0; declare -a CMDS=(); declare -a VABS=(); declare -a VPRES=()
while [ "${1-}" ]; do case "$1" in
  --file)      [ "${2-}" ] || usage; F=$2; shift 2;;
  --cmd)       [ "${2-}" ] || usage; CMDS+=(''"$2"'' ); shift 2;;
  --verify-absent) [ "${2-}" ] || usage; VABS+=(''"$2"'' ); shift 2;;
  --verify-present) [ "${2-}" ] || usage; VPRES+=(''"$2"'' ); shift 2;;
  --keep-bak)  KEEP_BAK=1; shift;;
  -h|--help)   usage;;
  *) echo "Unknown arg: $1" >&2; usage;;
esac; done

[ -n "$F" ] || usage
[ ${#CMDS[@]} -gt 0 ] || { echo "No --cmd supplied" >&2; exit 2; }
[ -f "$F" ] || { echo "File not found: $F" >&2; exit 2; }

B="$F.transaction_bak"; T=$(mktemp)
rollback(){ echo "ERROR: rolling back" >&2; [ -f "$B" ] && mv -f -- "$B" "$F" || true; [ -f "$T" ] && rm -f -- "$T" || true; exit 1; }
trap rollback ERR INT

cp -f -- "$F" "$B"
cp -f -- "$F" "$T"

{ for c in "${CMDS[@]}"; do printf "%s\n" "$c"; done; printf "%s\n" "wq"; } | ed -s "$T"

for pat in "${VABS[@]}"; do [ -z "$pat" ] && continue; if grep -Eq -- "$pat" "$T"; then echo "Verify failed: present -> $pat" >&2; exit 1; fi; done
for pat in "${VPRES[@]}"; do [ -z "$pat" ] && continue; if ! grep -Eq -- "$pat" "$T"; then echo "Verify failed: missing -> $pat" >&2; exit 1; fi; done

mv -f -- "$T" "$F"
[ "$KEEP_BAK" -eq 1 ] || rm -f -- "$B"
echo "OK: updated $F"
